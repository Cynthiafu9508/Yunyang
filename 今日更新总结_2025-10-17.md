# 云养APP更新总结 - 2025年10月17日

## 📋 更新概览

今日完成了v2.0到v3.0的重要迭代，主要包括：
- 完善商业化体系（每日签到、心跳值消耗、充值系统）
- 实现人物档案三种模式（创建/查看/编辑）
- 优化页面间跳转逻辑和数据联动
- 详细区分AI识别与手动编辑场景

---

## 🎯 核心功能更新

### 1. 每日签到系统

**功能描述**:
- 用户每日首次登录自动赠送50点心跳值
- 自动弹窗提示签到成功
- 有效期至当日24:00，次日自动清零
- 优先消耗每日赠送心跳值

**涉及页面**:
- homepage.html - 页面加载时自动检查并签到
- profile.html - 页面加载时自动检查并签到
- chat.html - 优先消耗每日赠送心跳值

**数据存储**:
```javascript
{
  dailyHeartBalance: 50,           // 每日赠送（24点清零）
  lastSignInDate: "Fri Oct 17 2025" // 最后签到日期
}
```

---

### 2. 商业化充值体系

**功能描述**:
- 会员套餐：周度（¥9.9）、月度（¥19.9）
- 心动充值：¥3、¥6、¥12三个固定档位
- 充值获得永久心跳值和人物创建额度
- 与聊天消耗、创建人物完全联动

**涉及页面**:
- recharge.html - 充值中心（新增页面）
- profile.html - 订阅充值入口
- chat.html - 心跳值不足引导充值
- character-profile.html - 创建额度不足引导充值

**定价策略**:

会员套餐：
| 套餐 | 价格 | 心跳值 | 创建额度 | VIP时长 |
|------|------|--------|----------|---------|
| 周度 | ¥9.9 | 1000 | 3个 | 7天 |
| 月度 | ¥19.9 | 2500 | 7个 | 30天 |

心动充值：
| 档位 | 价格 | 心跳值 | 创建额度 |
|------|------|--------|----------|
| 小额 | ¥3 | 200 | 1个 |
| 中档 | ¥6 | 500 | 3个 |
| 大额 | ¥12 | 1200 | 7个 |

---

### 3. 心跳值消耗机制

**功能描述**:
- 每次发送消息消耗1点心跳值
- 优先消耗每日赠送，再消耗永久心跳值
- 心跳值不足时阻止发送并引导充值
- 右上角实时显示总心跳值余额

**消耗逻辑**:
```
发送消息
    ↓
检查：dailyHeartBalance + heartBalance ≥ 1 ?
    ↓ 否
弹窗："心跳值不足，是否前往充值？"
    ↓ 是（充足）
优先消耗dailyHeartBalance
dailyHeartBalance不足则消耗heartBalance
更新localStorage和页面显示
发送消息成功
```

**涉及页面**:
- chat.html - 消耗心跳值
- profile.html - 显示余额
- recharge.html - 充值增加

---

### 4. 人物档案三种模式 🔥核心更新

**功能描述**:
- 支持创建、查看、编辑三种模式
- 根据URL参数自动初始化模式
- 不同模式显示不同功能和按钮

#### 模式对比表

| 功能 | create模式 | view模式 | edit模式 |
|------|-----------|----------|----------|
| 字段编辑 | ✅ 可编辑 | ❌ 只读 | ✅ 可编辑 |
| 头像编辑 | ✅ 可编辑 | ❌ 禁用 | ✅ 可编辑 |
| 标签选择 | ✅ 可选择 | ❌ 禁用 | ✅ 可选择 |
| 自定义标签 | ✅ 可添加 | ❌ 禁用 | ✅ 可添加 |
| 标签删除 | ✅ 可删除 | ❌ 隐藏 | ✅ 可删除 |
| 编辑图标 | ✅ 显示 | ❌ 隐藏 | ✅ 显示 |
| ⋯菜单 | ❌ 隐藏 | ✅ 显示 | ❌ 隐藏 |
| 底部按钮 | 创建人物 | 隐藏 | 保存修改 |
| AI标识 | ✅ 显示 | ❌ 隐藏 | ❌ 隐藏 |

#### 使用场景

**创建模式**:
```
upload.html（上传照片）
    ↓ AI识别
character-profile.html?mode=create&from=upload
    ↓ 编辑确认，点击"创建人物"
homepage.html或contacts.html
```

**查看模式**:
```
chat.html（点击头像）
    ↓
character-profile.html?mode=view&from=chat&id=xxx
（只读查看，显示⋯菜单）
    ↓ 点击"← 返回"
chat.html（返回聊天）
```

**编辑模式**:
```
查看模式
    ↓ 点击⋯ → 选择"编辑人物"
character-profile.html?mode=edit&from=chat&id=xxx
（可编辑，显示"保存修改"）
    ↓ 点击"保存修改"
返回view模式
```

---

### 5. 初始关系设定字段 🆕

**功能描述**:
- 新增"初始关系"字段
- 6个预设关系选项
- 影响聊天时的称呼和氛围

**6个预设关系**:
1. 青梅竹马 - 从小玩伴，深厚情感
2. 暧昧好友 - 朋友恋人之间（默认）
3. 久别重逢 - 失联重逢，复杂情感
4. 陌生人 - 初次相识，探索了解
5. 恋人 - 正式恋爱，甜蜜时光
6. 同事 - 工作搭档，办公室恋情

**对聊天影响**:
- 称呼方式：恋人→"宝贝"，好友→"名字"，陌生人→"你"
- 亲密度：影响对话的亲密程度
- 语气：恋人更甜蜜，陌生人更礼貌

---

### 6. 联系人管理优化

**功能描述**:
- 联系人列表与已创建人物绑定
- 动态读取characterList
- 移除心动管家
- 仅显示用户创建的人物

**涉及页面**:
- contacts.html - 动态渲染人物列表
- profile.html - 我的人物跳转到contacts

**默认数据**:
- 初始包含"小仙女Alice"
- 空状态显示创建提示

---

### 7. 个人中心完善

**功能描述**:
- 显示心跳值余额（总计）
- 显示VIP会员状态和到期时间
- 显示已创建人物数量
- 订阅充值入口
- 联系我们

**新增功能**:
- ✅ 订阅充值入口（合并会员订阅和心动充值）
- ✅ 联系我们（官方联系方式）
- ✅ 我的人物（跳转联系人）

**移除功能**:
- ❌ 朋友圈
- ❌ 账号安全
- ❌ 消息设置
- ❌ 关于我们
- ❌ 帮助与反馈

---

## 🔑 核心业务逻辑说明

### 业务逻辑1：心跳值消耗与充值联动

**流程图**:
```
用户发送消息
    ↓
消耗1点心跳值（优先每日赠送）
    ↓
心跳值不足？
    ↓ 是
提示："心跳值不足，是否前往充值？"
    ↓ 确认
跳转recharge.html
    ↓ 选择套餐充值
heartBalance增加（永久心跳值）
    ↓ 返回
所有页面余额同步更新
可以继续聊天
```

**关键点**:
- 🔥 每次发送消息必须检查心跳值
- 🔥 心跳值不足时引导充值
- 🔥 所有页面通过localStorage共享数据

---

### 业务逻辑2：创建人物额度检查与充值

**流程图**:
```
编辑人物信息完成
    ↓
点击"创建人物"
    ↓
检查createQuota > 0 ?
    ↓ 否
弹窗提示：创建额度不足
显示所有充值选项
    ↓ 确认充值
跳转recharge.html
    ↓ 充值成功
createQuota增加
    ↓ 返回
可以创建人物
    ↓ 是（有额度）
消耗1个额度
保存到characterList
跳转到聊天列表
```

**关键点**:
- 🔥 初始用户免费1个创建额度
- 🔥 超出后必须充值获取
- 🔥 每创建1个人物消耗1个额度

---

### 业务逻辑3：AI识别与头像编辑的区分 🔥最重要

**场景A - upload.html上传照片（AI识别）**:
```
用户上传照片
    ↓
✅ 调用AI视觉识别API
    ↓
分析照片特征
    ↓
✅ 自动生成完整人设：
  - 昵称
  - 出生日期
  - 职业背景
  - 性格特征
  - 说话风格
  - 初始关系（默认）
    ↓
跳转到character-profile.html展示
```

**场景B - character-profile.html更换头像（仅换图）**:
```
用户点击头像（edit/create模式）
    ↓
选择新头像（表情或照片）
    ↓
❌ 不调用AI识别API
❌ 不重新生成人设
❌ 不修改其他字段
    ↓
✅ 仅更新avatarUrl
✅ 其他字段保持不变
```

**核心差异**:
| 维度 | upload.html | character-profile.html |
|------|-------------|------------------------|
| AI识别 | ✅ 必须调用 | ❌ 绝不调用 |
| 人设生成 | ✅ 生成全部字段 | ❌ 保持不变 |
| 使用意图 | AI帮我生成人设 | 只想换个头像 |

**设计初衷**:
避免用户辛苦编辑的人设被意外覆盖。

---

## 📊 今日修改文件清单

### HTML页面（6个）

1. **character-profile.html** ⭐最大更新
   - 实现三种模式（create/view/edit）
   - 新增初始关系字段
   - 头像编辑功能（不触发AI）
   - ⋯菜单（编辑人物/删除好友）
   - 智能返回逻辑
   - 页面标题优化

2. **chat.html**
   - 右上角心跳值显示
   - 发送消息消耗心跳值
   - 所有头像可点击查看档案
   - 心跳值不足引导充值
   - 移除表情按钮

3. **profile.html**
   - 显示心跳值余额和VIP状态
   - 每日自动签到
   - 订阅充值入口
   - 我的人物功能
   - 联系我们（更新联系方式）
   - 精简功能菜单

4. **recharge.html** 🆕新增页面
   - 会员套餐（周度/月度）
   - 心动充值（¥3/¥6/¥12）
   - 充值成功更新数据
   - 自动返回个人中心

5. **contacts.html**
   - 绑定characterList数据
   - 动态渲染人物列表
   - 移除心动管家
   - 空状态提示

6. **homepage.html**
   - 每日自动签到功能

---

### 需求文档（3个）

1. **character-profile_需求文档.md** (v2.0 → v3.0) ⭐完全重写
   - 详细说明三种模式
   - AI识别与头像编辑的核心区分
   - 初始关系字段说明
   - 智能返回逻辑
   - 完整的用户流程

2. **chat_需求文档.md** (v2.0 → v2.1)
   - 补充头像点击查看档案功能
   - 心跳值消耗机制详细说明
   - 与充值系统联动逻辑

3. **profile_需求文档.md** (v1.0 → v2.0)
   - 每日签到功能说明
   - 资产展示详细说明
   - 订阅充值功能

4. **recharge_需求文档.md** (v1.0) 🆕新增
   - 完整的充值功能需求
   - 套餐定价策略
   - 充值流程说明

5. **README.md** (v1.0 → v2.0)
   - 完整项目文档
   - 数据结构说明
   - 业务流程图

6. **功能更新说明_v2.0.md** 🆕新增
   - 综合更新说明
   - 功能对比表

---

## 💾 数据结构总览

### localStorage完整数据

```javascript
{
  // 用户认证
  userToken: "xxx",
  userInfo: {...},
  
  // 资产数据
  heartBalance: 2350,              // 永久心跳值（充值获得）
  dailyHeartBalance: 50,           // 每日赠送（24点清零）
  createQuota: 10,                 // 剩余创建额度
  
  // 人物数据
  characterList: [
    {
      id: "alice_001",
      avatarUrl: "👩",             // 头像
      name: "小仙女Alice",
      birthday: "1998-05-20",
      occupation: "学生",          // 职业背景
      personality: "温柔体贴",      // 性格特征
      speakingStyle: "温柔宠溺",    // 说话风格
      initialRelation: "暧昧好友",  // 初始关系 🆕
      createTime: "2025-10-17T...",
      lastModified: "2025-10-17T..."
    }
  ],
  characterCount: 1,
  
  // 签到数据
  lastSignInDate: "Fri Oct 17 2025"
}
```

---

## 🔗 页面跳转关系图

```
login.html
    ↓ 登录成功
homepage.html（每日签到弹窗）
    ↓ 点击+或上传
upload.html
    ↓ 上传照片，AI识别
character-profile.html（create模式）
    ↓ 创建人物
homepage.html/contacts.html
    ↓ 点击人物
chat.html（聊天消耗心跳值）
    ↓ 点击头像
character-profile.html（view模式）
    ↓ 点击⋯ → 编辑人物
character-profile.html（edit模式）
    ↓ 保存修改
返回view模式
    ↓ 返回
chat.html
    ↓ 心跳值不足
recharge.html（充值）
    ↓ 充值成功
profile.html（余额更新）
```

---

## ✅ 功能验收清单

### 每日签到
- [x] 每日首次登录弹窗
- [x] 同一天只弹一次
- [x] 24点后可再次领取
- [x] 赠送50心跳值

### 心跳值消耗
- [x] 发送消息消耗1点
- [x] 优先消耗每日赠送
- [x] 不足时提示充值
- [x] 右上角实时显示

### 充值功能
- [x] 套餐选择正确
- [x] 充值成功后数据更新
- [x] 跨页面余额同步

### 创建人物
- [x] 检查创建额度
- [x] 额度不足提示充值
- [x] 创建成功消耗额度
- [x] 保存到characterList

### 三种模式
- [x] create模式可编辑
- [x] view模式完全只读
- [x] edit模式可编辑
- [x] 模式切换流畅
- [x] 智能返回正确

### 头像编辑
- [x] edit/create可编辑
- [x] view模式禁用
- [x] 不触发AI识别
- [x] 不改变人设

### 联系人管理
- [x] 绑定人物数据
- [x] 动态渲染列表
- [x] 点击进入聊天

---

## 📞 官方联系方式

- **客服邮箱**: 17621792630@163.com
- **官方客服微信**: 17621792630
- **官方小红书账号**: Dokidoki官方号
- **工作时间**: 9:00-18:00

---

## 🚀 下一步计划

### v3.1 待开发
- [ ] 完善更换头像功能（实际图片上传）
- [ ] 消费记录查询
- [ ] VIP特权详情页
- [ ] 我的人物独立页面

### v3.2 待开发
- [ ] 签到日历
- [ ] 成就系统
- [ ] 好友邀请奖励
- [ ] 分享功能

---

**文档创建**: 2025年10月17日  
**版本**: v3.0更新总结  
**维护者**: 云养产品团队

