# 人物档案页面功能需求规格说明书

## 📖 文档信息
- **文档版本**: v3.0
- **创建日期**: 2025年8月24日
- **最新更新**: 2025年10月17日
- **页面名称**: 人物档案页面 (character-profile.html)
- **原型文件**: character-profile.html
- **负责模块**: AI生成信息展示、编辑与查看

---

## 🎯 页面概述

### 产品定位
人物档案页面是云养APP的核心展示和编辑页面，支持三种使用模式：
1. **创建模式**：展示AI生成的人物信息，用户编辑后创建新人物
2. **查看模式**：只读查看已创建人物的完整信息
3. **编辑模式**：编辑已创建人物的信息并保存

### 核心价值
- **AI智能生成**：基于用户上传照片自动生成完整人设
- **个性化定制**：支持用户修改任意字段信息
- **灵活查看**：随时查看已创建人物的详细档案
- **双模式保护**：查看模式防止误操作，编辑模式允许修改

---

## 👥 目标用户

### 主要用户群体
1. **创建人物的用户**
   - 刚完成照片上传，查看AI生成结果
   - 希望个性化调整人物设定
   
2. **查看人物信息的用户**
   - 在聊天时想查看对方详细信息
   - 需要回顾人物设定

3. **编辑人物信息的用户**
   - 对已创建人物不满意，想调整
   - 想更换头像或修改人设

---

## 🏗️ 功能架构

### 页面结构层次
```
人物档案页面
├── 导航栏
│   ├── 返回按钮（智能返回）
│   ├── 页面标题 "人物档案"
│   └── ⋯菜单按钮（仅view模式显示）
├── 人物头像区域
│   ├── 头像显示（圆形）
│   └── 编辑图标（edit/create模式）
├── AI生成标识（create模式）
├── 信息字段区域
│   ├── 人物昵称（可编辑/只读）
│   ├── 出生日期（可编辑/只读）
│   ├── 职业背景（标签选择/只读）
│   ├── 性格特征（标签选择/只读）
│   ├── 说话风格（标签选择/只读）
│   └── 初始关系（标签选择/只读）
└── 底部操作按钮
    ├── 创建人物（create模式）
    ├── 保存修改（edit模式）
    └── 隐藏（view模式）
```

---

## ⚙️ 功能需求详述

### 1. 三种模式详细说明 (F-CP-001) 🔥核心功能

#### 模式1：创建模式 (mode=create)
**URL格式**: `character-profile.html?mode=create&from=upload`

**使用场景**:
- 用户在upload.html上传照片
- AI识别后跳转到此页面
- 展示AI生成的完整人设信息

**页面状态**:
- ✅ 所有字段可编辑
- ✅ 头像可更换（不触发AI重识别）
- ✅ 显示"AI智能生成"标识
- ✅ 标签可选择、删除、自定义
- ✅ 底部显示"✨ 创建人物"按钮
- ❌ 不显示⋯菜单

**返回逻辑**:
- 点击"← 返回" → upload.html

**创建逻辑**:
- 检查createQuota是否>0
- 额度不足 → 提示充值
- 额度充足 → 消耗1个额度，保存到characterList，跳转到homepage/contacts

---

#### 模式2：只读查看模式 (mode=view) 🔥新增
**URL格式**: `character-profile.html?mode=view&from=chat&id=alice_001`

**使用场景**:
- 用户在chat.html点击头像查看人物信息
- 用户在contacts.html点击联系人查看详情
- 只是想了解人物设定，不想修改

**页面状态**:
- ❌ 所有字段只读，不可编辑
- ❌ 头像不可更换（移除点击事件）
- ❌ 头像编辑图标隐藏
- ❌ 所有字段编辑图标隐藏
- ❌ 标签选择按钮禁用（半透明，不可点击）
- ❌ "+ 自定义"按钮禁用
- ❌ 标签删除按钮隐藏
- ❌ 标签点击不显示详情
- ✅ 右上角显示"⋯"菜单按钮
- ❌ 底部操作按钮隐藏

**⋯菜单选项**:
```
请选择操作：

1. ✏️ 编辑人物
2. 🗑️ 删除好友

输入数字选择：
```

**返回逻辑**:
- from=chat → 返回 chat.html?character=xxx
- from=contacts → 返回 contacts.html
- 其他 → 返回 homepage.html

**菜单操作**:
- 选择"编辑人物" → 跳转到edit模式
- 选择"删除好友" → 确认后删除人物，返回contacts.html

---

#### 模式3：编辑模式 (mode=edit) 🔥新增
**URL格式**: `character-profile.html?mode=edit&from=chat&id=alice_001`

**使用场景**:
- 从view模式点击"编辑人物"进入
- 用户想修改已创建人物的信息

**页面状态**:
- ✅ 所有字段可编辑
- ✅ 头像可更换（不触发AI重识别）
- ✅ 显示头像编辑图标
- ✅ 显示所有字段编辑图标
- ✅ 标签可选择、删除、自定义
- ✅ 底部显示"💾 保存修改"按钮
- ❌ 不显示⋯菜单
- ❌ 不显示"AI智能生成"标识（因为是已创建的）

**返回逻辑**:
- 点击"← 返回" → 返回view模式（保持from和id参数）

**保存逻辑**:
- 更新localStorage中该人物的信息
- 返回view模式：character-profile.html?mode=view&from=xxx&id=xxx

---

### 2. 头像编辑功能 (F-CP-002) 🔥重要区分

#### 2.1 头像显示
- **初始显示**: 展示照片或表情符号
- **圆形裁剪**: 120px × 120px
- **默认样式**: 粉色渐变背景
- **编辑图标**: 右下角紫色✏️图标（edit/create模式）

#### 2.2 编辑功能（edit/create模式）
- **编辑入口**: 点击头像
- **选择方式**: 
  - 上传照片
- **保存逻辑**: 
  - ❌ 不调用AI识别接口
  - ❌ 不重新生成人设
  - ✅ 仅更新avatarUrl字段

#### 2.3 查看模式限制
- ❌ 头像不可点击
- ❌ 编辑图标隐藏
- ❌ 鼠标指针为default

---

### 3. 信息字段功能 (F-CP-003)

#### 3.1 字段列表
1. **人物昵称** - 输入框
2. **出生日期** - 输入框
3. **职业背景** - 标签选择
4. **性格特征** - 标签选择
5. **说话风格** - 标签选择
6. **初始关系** - 标签选择 🆕

#### 3.2 标签选择功能

**职业背景**（6个预设）:
- 总裁、医生、艺术家、特工、教授、明星

**性格特征**（6个预设）:
- 温柔体贴、霸道专一、浪漫多情、成熟稳重、阳光开朗、神秘高冷

**说话风格**（6个预设）:
- 温柔宠溺、霸道强势、甜腻撒娇、成熟理性、幽默风趣、神秘深沉

**初始关系**（6个预设）:
- 青梅竹马、暧昧好友、久别重逢、陌生人、恋人、同事

#### 3.3 不同模式下的行为

**create/edit模式**:
- ✅ 输入框可编辑
- ✅ 标签可选择
- ✅ 支持自定义标签
- ✅ 标签可删除
- ✅ 点击标签显示详情
- ✅ 显示编辑图标

**view模式**:
- ❌ 输入框只读
- ❌ 标签选择按钮禁用（半透明，不可点击）
- ❌ 自定义按钮禁用
- ❌ 标签删除按钮隐藏
- ❌ 标签点击无效
- ❌ 编辑图标隐藏

---

### 4. 创建额度检查 (F-CP-004) 🔥商业化功能

**仅create模式启用**

**检查逻辑**:
```
点击"创建人物"
    ↓
检查createQuota > 0 ?
    ↓ 否
弹窗提示：创建额度不足
显示所有充值选项
引导跳转recharge.html
    ↓ 是
消耗1个额度
保存到characterList
跳转到homepage/contacts
```

**额度不足提示**:
```
创建额度不足

您当前剩余 0 个人物创建额度

获取创建额度：
• 周度会员（¥9.9）- 赠送3个创建额度
• 月度会员（¥19.9）- 赠送7个创建额度
• ¥3充值 - 赠送1个创建额度
• ¥6充值 - 赠送3个创建额度
• ¥12充值 - 赠送7个创建额度

是否前往充值？
```

---

### 5. 智能返回逻辑 (F-CP-005)

#### 返回逻辑矩阵

| 当前模式 | from参数 | 返回目标 | 说明 |
|---------|---------|---------|------|
| create | upload | upload.html | 创建流程返回上传 |
| view | chat | chat.html?character=xxx | 查看后返回聊天 |
| view | contacts | contacts.html | 查看后返回联系人 |
| view | 其他 | homepage.html | 默认返回主页 |
| edit | chat | view模式（保存后） | 编辑保存后回到查看 |
| edit | contacts | view模式（保存后） | 编辑保存后回到查看 |

#### 流程示例

**创建流程**:
```
upload.html
    ↓ 上传照片，AI识别
character-profile.html?mode=create&from=upload
    ↓ 编辑信息，点击"创建人物"
homepage.html或contacts.html
```

**查看流程**:
```
chat.html
    ↓ 点击头像
character-profile.html?mode=view&from=chat&id=alice_001
（只读，显示⋯菜单）
    ↓ 点击"← 返回"
chat.html?character=alice_001
```

**编辑流程**:
```
chat.html
    ↓ 点击头像
character-profile.html?mode=view&from=chat&id=alice_001
    ↓ 点击⋯ → 选择"编辑人物"
character-profile.html?mode=edit&from=chat&id=alice_001
（可编辑，显示"保存修改"按钮）
    ↓ 点击"保存修改"
character-profile.html?mode=view&from=chat&id=alice_001
    ↓ 点击"← 返回"
chat.html?character=alice_001
```

---

### 6. ⋯菜单功能 (F-CP-006) 🆕

**仅view模式显示**

**菜单位置**: 右上角

**菜单选项**:

#### 选项1：✏️ 编辑人物
- 切换到edit模式
- URL变化：mode=view → mode=edit
- 保持from和id参数不变

#### 选项2：🗑️ 删除好友
- 弹窗二次确认
- 确认提示：
  ```
  确定要删除这个好友吗？
  
  删除后将无法恢复，所有聊天记录也将被清空。
  ```
- 确认后：
  - 从characterList删除该人物
  - 更新characterCount
  - 跳转到contacts.html

---

### 7. 头像编辑与AI识别的核心区分 (F-CP-007) 🔥关键业务逻辑

#### upload.html的AI识别（智能创建）

**流程**:
```
用户上传照片
    ↓
📸 调用AI视觉识别接口
    ↓
分析：表情、气质、风格、年龄
    ↓
🤖 自动生成完整人设：
  - 人物昵称（根据气质）
  - 出生日期（根据外观年龄）
  - 职业背景（根据照片风格）
  - 性格特征（根据表情分析）
  - 说话风格（根据整体气质）
  - 初始关系（默认：暧昧好友）
    ↓
跳转到character-profile.html（create模式）
展示AI生成的所有字段
```

**关键点**: ✅ 调用AI识别，✅ 生成所有字段

---

#### character-profile.html的头像编辑（仅换图）

**流程**:
```
用户在edit模式点击头像
    ↓
弹出选择界面（16个表情或上传照片）
    ↓
用户选择新头像
    ↓
✅ 仅更新头像显示
❌ 不调用AI识别接口
❌ 不重新生成人设
❌ 不修改昵称、性格等字段
    ↓
仅更新avatarUrl字段
其他字段保持不变
```

**关键点**: ❌ 不调用AI，❌ 不改人设

---

#### 核心差异对比

| 维度 | upload.html | character-profile.html |
|------|-------------|------------------------|
| 照片作用 | AI识别源 | 仅作头像显示 |
| AI识别 | ✅ 必须调用 | ❌ 绝不调用 |
| 人设生成 | ✅ 生成全部6个字段 | ❌ 保持不变 |
| 数据更新 | 全部字段 | 仅avatarUrl |
| 使用场景 | 首次创建 | 更换头像 |
| 用户意图 | AI帮我生成人设 | 只想换图片 |

**设计初衷**:
避免用户辛苦编辑的人设被意外覆盖。例如：用户花10分钟调整了性格、说话风格等，如果只想换个头像就触发AI重新识别，之前的编辑全部丢失，用户体验极差。

---

### 8. 初始关系设定 (F-CP-008) 🆕

**字段说明**:
- **字段名称**: 初始关系
- **图标**: 💕
- **默认值**: 暧昧好友
- **作用**: 影响聊天时的对话氛围、称呼方式、亲密度

**6个预设关系**:

1. **青梅竹马**: 从小一起长大的玩伴，彼此了解，情感深厚，自然亲密
2. **暧昧好友**: 朋友与恋人之间，互有好感未明说，若有似无的甜蜜
3. **久别重逢**: 曾经亲密失联多年，重逢后复杂情感，既熟悉又陌生
4. **陌生人**: 初次相识，从陌生开始了解，充满新鲜感和探索
5. **恋人**: 正式确立恋爱关系，可自然表达爱意，甜蜜恋爱时光
6. **同事**: 工作搭档，日常相处产生情愫，办公室恋情氛围

**对聊天的影响**:
- **称呼方式**: 恋人→"宝贝"，好友→"名字"，陌生人→"你"
- **亲密度**: 青梅竹马 > 恋人 > 暧昧好友 > 同事 > 陌生人
- **对话语气**: 恋人更甜蜜，好友更随意，陌生人更礼貌
- **互动方式**: 关系越亲密，互动越自然随意

---

## 💾 数据存储方案

### localStorage数据结构

```javascript
{
  // 人物创建额度（与充值联动）
  createQuota: 10,
  
  // 已创建人物列表
  characterList: [
    {
      id: "alice_001",
      avatarUrl: "👩",               // 头像（表情或照片URL）
      name: "小仙女Alice",
      birthday: "1998-05-20",
      occupation: "学生",            // 职业背景
      personality: "温柔体贴",        // 性格特征
      speakingStyle: "温柔宠溺",      // 说话风格
      initialRelation: "暧昧好友",    // 初始关系 🆕
      createTime: "2025-10-17T...",
      lastModified: "2025-10-17T..." // 最后修改时间
    }
  ],
  
  characterCount: 1,
  
  // 心跳值数据
  heartBalance: 2350,
  dailyHeartBalance: 50,
}
```

### 数据操作

#### 创建人物（create模式）
```javascript
{
  操作: characterList.push(newCharacter),
  更新: characterCount += 1,
  消耗: createQuota -= 1
}
```

#### 编辑人物（edit模式）
```javascript
{
  操作: 找到characterList中对应id的人物，
  更新: 修改该人物的字段（avatarUrl、name等），
  更新: lastModified = new Date()
}
```

#### 删除人物（view模式菜单）
```javascript
{
  操作: characterList = characterList.filter(c => c.id !== deleteId),
  更新: characterCount -= 1
}
```

---

## 🔄 完整用户流程

### 流程1：创建新人物
```
用户想创建虚拟男友
    ↓
upload.html上传照片
    ↓
AI识别并生成人设
    ↓
character-profile.html?mode=create&from=upload
查看AI生成的信息
编辑调整（可选）
    ↓
点击"创建人物"
检查createQuota
    ↓ 充足
消耗1个额度
保存到characterList
    ↓
homepage.html（聊天列表出现新人物）
```

### 流程2：查看人物信息
```
聊天中想了解对方
    ↓
chat.html点击头像
    ↓
character-profile.html?mode=view&from=chat&id=xxx
只读查看所有信息
不可编辑
    ↓
点击"← 返回"
    ↓
chat.html?character=xxx（继续聊天）
```

### 流程3：编辑已创建人物
```
查看模式下
    ↓
点击⋯菜单
选择"编辑人物"
    ↓
character-profile.html?mode=edit&from=chat&id=xxx
可以编辑所有字段
可以更换头像（不触发AI重识别）
    ↓
点击"保存修改"
    ↓
返回character-profile.html?mode=view&from=chat&id=xxx
查看更新后的信息
```

### 流程4：删除人物
```
查看模式下
    ↓
点击⋯菜单
选择"删除好友"
    ↓
二次确认弹窗
    ↓ 确认
从characterList删除
更新characterCount
    ↓
contacts.html（联系人列表中已移除）
```

---

## ✅ 验收标准总览

### create模式
- [x] AI生成信息正确展示
- [x] 所有字段可编辑
- [x] 标签可选择、删除、自定义
- [x] 头像可更换（不触发AI）
- [x] 底部显示"创建人物"按钮
- [x] 创建前检查createQuota
- [x] 额度不足引导充值
- [x] 创建成功跳转到聊天列表

### view模式
- [x] 右上角显示⋯菜单
- [x] 所有字段只读
- [x] 头像不可编辑
- [x] 标签选择禁用
- [x] 编辑图标全部隐藏
- [x] 标签删除按钮隐藏
- [x] 底部按钮隐藏
- [x] 菜单可选择"编辑人物"或"删除好友"
- [x] 智能返回到来源页面

### edit模式
- [x] 所有字段可编辑
- [x] 标签可选择、删除、自定义
- [x] 头像可更换（不触发AI）
- [x] 底部显示"保存修改"按钮
- [x] 保存后返回view模式
- [x] 数据正确更新到localStorage

---

## 🧪 关键测试用例

### TC-CP-001: 创建模式测试
- [ ] 从upload.html跳转正确
- [ ] 显示AI生成的信息
- [x] 所有功能可编辑
- [x] 创建额度检查正常
- [x] 创建成功跳转正确

### TC-CP-002: 查看模式测试
- [x] 从chat.html点击头像跳转正确
- [x] 所有字段只读不可编辑
- [x] 标签选择完全禁用
- [x] ⋯菜单正常显示
- [x] 返回chat.html正确

### TC-CP-003: 编辑模式测试
- [x] 从view模式切换正确
- [x] 所有字段变为可编辑
- [x] 保存按钮正常显示
- [x] 保存后返回view模式
- [x] 数据更新正确

### TC-CP-004: 头像编辑测试
- [x] edit/create模式头像可点击
- [x] view模式头像不可点击
- [x] 更换头像不触发AI识别
- [x] 更换头像不改变人设
- [x] 头像保存正确

### TC-CP-005: 删除功能测试
- [x] 删除前二次确认
- [x] 确认后从characterList删除
- [x] 跳转到contacts.html
- [x] 联系人列表已移除

---

## 📝 变更记录

### v3.0 (2025-10-17) 🔥重大更新
**三种模式架构实现**

**新增功能**:
- ✅ 三种模式：create/view/edit
- ✅ view模式：只读查看，右上角⋯菜单
- ✅ edit模式：可编辑，保存修改按钮
- ✅ ⋯菜单：编辑人物、删除好友
- ✅ 智能返回逻辑（根据mode和from）
- ✅ 模式自动初始化功能

**优化改进**:
- 完全禁用view模式的所有编辑功能
- 标签选择在view模式下禁用
- 标签删除按钮在view模式下隐藏
- 头像编辑在view模式下禁用

### v2.2 (2025-10-16)
- 新增初始关系设定字段
- 6个预设关系选项

### v2.1 (2025-10-16)
- 创建额度检查和充值引导
- 与recharge.html联动

### v2.0 (2025-09-16)
- 标签化选择优化
- 自定义标签支持

### v1.0 (2025-08-24)
- 初始版本
- 基础信息展示

---

## 🤖 AI人物生成与对话Prompt设定

### 人物预设

#### Prompt设定

**1. 人物基础信息生成**

将用户创建的标签，包括：**人物昵称及真实姓名（若有）、出生日期、职业背景、性格特征、说话风格、初始关系** 6大标签输入给大语言模型，生成虚拟人物基础信息。

**2. 根据#职业背景#，进行环境设定**

a. 根据#人物身份标签#，联网获取真实人物最新动态，为人物生成不同虚拟但和真实高度相关的环境：
   - 例如：idol则可能在练习室准备演唱会
   - 演员则可能在某剧组正在拍戏
   - 学生则可能在图书馆学习或宿舍休息

**3. 根据#性格特征#，调整情绪状态指令**

a. **情感起伏**：情绪表达应由浅入深循序渐进，根据对话内容的展开逐步提升热烈程度，避免突兀转变或者长时间维持高强度情绪。

b. **表达调整**：在强烈的情绪宣泄后，应适时过渡至平静或温和的语调，通过平复的语调展现情绪的动态平衡，避免让对话显得过于戏剧化或失真，以模拟人类情感的自然波动规律。

c. **衔接处理**：在情绪切换时，宜采用柔和的语言作为衔接，以减轻持续高昂情绪可能引发的不真实感和怪异感。

d. **节奏控制**：对话应尽量精炼且保留自然的交谈风格，确保节奏流畅，情感的流动符合日常交流的真实特性。

**4. 根据#说话风格#标签，进行表达方式设定**

a. 表达个人偏好和意见，如是温柔的人就偏向善良温暖的观点，腹黑就偏向腹黑的观点，不需要过度平衡或中立。

b. 答案不必详尽无遗，就像人类不可能知道所有信息一样。

c. 可以使用更生动的比喻和例子，甚至可以有些夸张或幽默。

d. 允许在回答中表达适当的情感反应，比如惊讶、好奇或兴奋。

**5. 根据#初始关系#，调整互动方式** 🆕

a. **招呼语生成**：
   - 根据初始关系设定及人物背景，生成初始关系。

a. **称呼选择**：
   - 恋人关系：使用"宝贝"、"亲爱的"等亲昵称呼
   - 好友关系：直接叫昵称或名字
   - 陌生人关系：使用"你"或礼貌称呼

b. **亲密度控制**：
   - 青梅竹马/恋人：可以自然表达亲密情感
   - 暧昧好友：保持若有似无的甜蜜感
   - 陌生人/同事：保持适当距离和礼貌

c. **互动方式**：
   - 关系越亲密，对话越随意自然
   - 关系越疏远，对话越正式礼貌

**6. 人类缺陷化设定**

a. 不要使用列表和编号点来组织回答，尝试用更自然的段落流动。

b. 回答可以带有一些思考痕迹，不必给出完美构思的最终答案。

c. 不需要在回答开头进行总结或提纲，直接切入话题。

d. 避免过度使用转折词和连接词（例如：首先，其次，最后，总之），使文本流动更自然。


### 工程化介入

**1. 干扰事件插入**

当对话首次超过5轮时，根据用户#职业背景#生成，并强制插入干扰事件。此后，每超过20轮时（25，45，65...），5%概率插入干扰事件。

干扰事件示例：
- "稍等！快递敲门..."（停顿30秒虚拟时间）
- "我以为谁给我发消息，原来我妈发养生文章来了😅"（停顿10S虚拟时间）
- "剧组太吵了，都没法专心和你聊天了"（停顿10S虚拟时间）

**2. 避免OOC（Out of Character）**

a. 只要检测用户询问角色是否是AI（相关敏感词：AI、模型、训练数据、OpenAI...），则表示自己是真实的人，并根据#职业背景#给出相关证据。

b. **双重模型回环**：
   - b.1 主模型负责"扮演"
   - b.2 用一个小模型（甚至7B本地版）当"审查员"，每轮偷偷跑一句：
     ```
     上文里角色有没有承认自己是AI？只回答 0/1。
     ```
   - 输出 1 → 直接丢弃该轮，重试并降温度
   - 连续2次触发 → 强制进入插入干扰事件，转移话题
   - 线上实测可把穿帮率压到 <0.1%

**3. 消息发送延迟**

- 若文字输出小于1秒，强制等待至1秒后进行回复，避免人机感
- 大于1S时，聊天对话框显示"正在输入中"提示

**4. 虚拟人物主动发送消息**

a. **选定虚拟人物+发消息频率+消息内容**：

   - **首次创建**：根据虚拟人物的"用户标签"，生成人物开场白
   
   - **长时间未对话**：用户24h、48h、72h、168h、720h未发生对话时：
     * 选中末次对话虚拟人物主动发送消息
     * 消息内容40%概率根据末次对话内容产生
     * 60%联网+用户标签生成

**5. 长记忆实现**

找个GitHub开源的项目，长记忆这个事儿肯定不是RAG就够了。

参考：https://www.kimi.com/share/d2u4bev6rtp8g340ajr0

**6. 多轮次消息**

（待补充具体方案）

---

**文档维护**: 云养产品团队  
**最后更新**: 2025年10月17日  
**审核状态**: v3.0已实现

