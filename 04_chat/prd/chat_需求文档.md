# 聊天详情页面产品需求文档 (PRD)

## 📋 文档信息
- **文档版本**: v0.3
- **创建日期**: 2025年8月24日
- **最后更新**: 2025年10月18日
- **页面名称**: 聊天详情页面
- **原型文件**: chat.html

---

## 🏗️ 页面结构

```
聊天详情页面
├── 状态栏 (系统级)
├── 聊天头部
│   ├── 返回按钮
│   ├── 人物头像（可点击查看档案）
│   ├── 人物信息（昵称、在线状态）
│   └── ❤️ 心跳值显示（实时余额）
├── 正在输入提示
├── 消息显示区域
│   ├── 接收消息气泡（左侧白色）
│   ├── 发送消息气泡（右侧蓝紫色）
│   └── 时间戳显示
└── 消息输入区域
    ├── 输入框（多行，仅文字）
    └── 发送按钮
```

---

## ⚙️ 功能需求详述

聊天详情页面提供与AI虚拟人物的实时对话，包含6个核心功能：聊天头部、消息显示、智能回复、心跳值消耗、消息输入、正在输入提示。

### 1. 聊天头部功能 (F8.1)
- 返回按钮：点击返回聊天主页 (homepage.html)
- 人物头像：可点击查看人物档案 (character-profile.html?mode=view&from=chat&id=xxx)
- 人物信息：昵称、在线状态（在线/正在输入...）
- 心跳值显示：
  - 位置：右上角
  - 图标：❤️（带心跳动画）
  - 数值：实时显示总心跳值余额（永久+今日赠送）
  - 格式：使用千分位分隔符
  - 点击行为：弹窗显示心跳值详情
- 样式由设计师设计

**心跳值详情弹窗**:
```
💖 心跳值详情

总计：2,400 个心跳值

• 永久心跳值：2,350
• 今日赠送：50（24点清零）

每次发送消息消耗1点心跳值
优先消耗今日赠送心跳值

是否前往充值？
```

---

### 2. 消息显示功能 (F8.2)
- 消息气泡：用户发送（右侧蓝紫色）、AI回复（左侧白色）
- 消息内容：文本消息，自动换行和断字
- 时间戳：每条消息显示发送时间
- AI消息头像：左侧显示人物头像，可点击查看档案
- 所有头像可点击：头部头像、正在输入头像、消息头像
- 点击头像跳转：character-profile.html?mode=view&from=chat&id=xxx
- 消息区域自动滚动到最新消息
- 支持长文本自适应高度
- 样式由设计师设计

---

### 3. 智能回复功能 (F8.3)
- 回复延迟：模拟真人思考，1-3秒随机延迟
- 正在输入提示：显示"正在输入..."状态和动画
- 回复内容：根据用户消息生成相关回复，保持人物性格一致性
- 上下文理解：结合聊天历史生成连贯回复

---

### 4. 心跳值消耗机制 (F8.4) 核心商业化功能
**消耗规则**:
- 消耗时机：用户点击发送按钮时
- 消耗数量：每条消息消耗1点心跳值
- 消耗顺序：
  1. 优先消耗每日赠送心跳值（dailyHeartBalance）
  2. 每日赠送用完后，消耗永久心跳值（heartBalance）
  3. 两者都不足时，阻止发送并提示充值

**心跳值检查逻辑**:
```
发送消息前检查：
1. 获取dailyHeartBalance（每日赠送）
2. 获取heartBalance（永久心跳值）
3. 计算总计：totalBalance = dailyBalance + permanentBalance

if (totalBalance < 1) {
    弹窗提示："心跳值不足，无法发送消息。是否前往充值？"
    用户确认 → 跳转到recharge.html
    用户取消 → 停留在聊天页面
} else {
    if (dailyBalance >= 1) {
        dailyBalance -= 1  // 优先消耗每日赠送
    } else {
        permanentBalance -= 1  // 消耗永久心跳值
    }
    更新localStorage
    更新右上角显示
    发送消息
}
```

**心跳值显示更新**:
- 实时更新：每次发送消息后立即更新右上角显示
- 更新范围：右上角心跳值数字、localStorage数据
- 与充值系统联动：chat.html(消耗) ↔ recharge.html(充值) ↔ profile.html(显示)

---

### 5. 消息输入功能 (F8.5)
- 输入框：仅支持纯文字输入，多行文本支持
- 自动高度调整（最大5行）
- 占位符："输入消息..."
- 发送按钮：有内容时激活，无内容时禁用
- 点击前先检查心跳值余额
- Enter键发送消息（Shift+Enter换行）
- 发送后自动清空输入框
- 样式由设计师设计

---

### 6. 正在输入提示 (F8.6)
- 显示时机：AI准备回复时显示
- 动画效果：三个点的跳动动画
- 状态同步：与头部在线状态联动
- 自动隐藏：AI回复发送后自动消失

---

## 🎨 UI设计规范

所有页面视觉设计（包括颜色、字体、布局、间距、圆角、阴影、动画等）统一由设计师设计。

---

## 💾 数据存储方案

### localStorage数据结构
```javascript
{
  // 心跳值数据（与充值系统联动）
  heartBalance: 2350,                    // 永久心跳值（充值获得）
  dailyHeartBalance: 50,                 // 每日赠送心跳值（24点清零）
  lastSignInDate: "Wed Oct 16 2025",    // 上次签到日期
  
  // 聊天相关数据
  chatHistory: {...},                    // 聊天记录
  currentCharacter: "alice_001",         // 当前聊天人物ID
  
  // 用户数据
  characterList: [...],                  // 已创建人物列表
  characterCount: 5,                     // 已创建人物数量
  createQuota: 10                        // 剩余创建额度
}
```

### 数据读取逻辑
**页面加载时**:
1. 读取heartBalance（永久心跳值）
2. 读取dailyHeartBalance（每日赠送）
3. 检查lastSignInDate，如果日期变化则清零dailyHeartBalance
4. 计算总计并显示在右上角

**发送消息时**:
1. 检查总心跳值是否≥1
2. 如果不足，显示充值提示
3. 如果充足，优先消耗dailyHeartBalance
4. 更新localStorage数据
5. 更新页面显示

---

## ✅ 测试与验收标准

### 功能完整性
- [ ] 6个核心功能全部实现
- [ ] 返回按钮跳转正确 (homepage.html)
- [ ] 人物头像可点击，跳转到档案 (character-profile.html?mode=view&from=chat&id=xxx)
- [ ] 心跳值实时显示，使用千分位分隔符
- [ ] 心跳值详情弹窗显示正确
- [ ] 消息气泡样式正确（用户右侧、AI左侧）
- [ ] 时间戳显示准确
- [ ] 消息自动滚动到最新
- [ ] AI回复延迟合理（1-3秒）
- [ ] 正在输入动画流畅
- [ ] 发送前检查心跳值
- [ ] 优先消耗每日赠送心跳值
- [ ] 心跳值不足时阻止发送并提示
- [ ] 提示弹窗可跳转充值 (recharge.html)
- [ ] 右上角心跳值实时更新
- [ ] 输入框多行支持，最大5行
- [ ] Enter键发送，Shift+Enter换行
- [ ] 发送后自动清空输入框

### 交互体验
- [ ] 消息发送响应及时（< 200ms）
- [ ] AI回复生成快速（< 5秒）
- [ ] 滚动流畅无卡顿
- [ ] 心跳动画效果流畅
- [ ] 页面响应及时无延迟

---

## 📝 更新记录

| 版本 | 日期 | 更新内容 | 负责人 |
|------|------|----------|--------|
| v0.1 | 2025-08-24 | 初始版本创建 | Cynthia |
| v0.2 | 2025-10-16 | 新增心跳值消耗机制，商业化功能集成 | Cynthia |
| v0.3 | 2025-10-18 | 精简功能描述语言，保留核心商业化逻辑 | Cynthia |

---

**文档维护**: 云养产品团队  
**最后更新**: 2025年10月18日  
**版本**: v0.3
