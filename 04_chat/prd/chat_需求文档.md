# 聊天详情页面功能需求规格说明书

## 📖 文档信息
- **文档版本**: v2.0
- **更新日期**: 2025年10月16日
- **页面名称**: 聊天详情页面 (chat.html)
- **原型文件**: chat.html
- **负责模块**: AI人物对话核心功能与心跳值消耗

---

## 🎯 页面概述

### 产品定位
聊天详情页面是用户与AI虚拟人物进行实时对话的核心界面，提供类似微信的聊天体验，让虚拟人物表现得像真人一样进行交流。

### 核心价值
- **真实对话体验**: 仿真人的对话交互，包括延迟回复和正在输入提示
- **情感连接**: 通过自然对话建立用户与虚拟人物的情感纽带
- **智能互动**: AI根据用户消息智能生成个性化回复

---

## 👥 目标用户

### 主要用户群体
1. **情感陪伴需求用户** (18-35岁)
   - 寻求日常聊天和情感支持
   - 希望有人倾听和理解
   
2. **社交练习用户** (16-30岁)
   - 通过与AI对话练习社交技能
   - 提升表达能力和沟通技巧

3. **孤独感用户** (全年龄段)
   - 独居或缺乏社交的用户
   - 需要温暖陪伴和关怀

### 用户使用场景
- **日常聊天**: 分享生活点滴，获得回应和关怀
- **情绪倾诉**: 在压力大或情绪低落时寻求安慰
- **兴趣交流**: 讨论共同话题和兴趣爱好
- **深夜陪伴**: 失眠或孤独时的心理支持

---

## 🏗️ 功能架构

### 页面结构层次
```
聊天详情页面
├── 聊天头部
│   ├── 返回按钮
│   ├── 人物头像
│   ├── 人物信息 (昵称、在线状态)
│   └── ❤️ 心跳值显示（实时余额）
├── 正在输入提示
├── 消息显示区域
│   ├── 接收消息气泡
│   ├── 发送消息气泡
│   └── 时间戳显示
└── 消息输入区域
    ├── 输入框 (支持多行，仅文字)
    └── 发送按钮
```

---

## ⚙️ 功能需求详述

### 1. 聊天头部功能 (F4.1)
**需求描述**: 显示对话人物信息、心跳值余额和操作入口
**优先级**: P0 (必须实现)

**功能细节**:
- **返回按钮**: "← 返回"，点击返回聊天主页
- **人物头像**: 显示虚拟人物头像或首字母
- **人物信息**: 
  - 昵称显示
  - 在线状态 (在线/正在输入...)
- **心跳值显示**: 
  - 位置：右上角
  - 图标：❤️（带心跳动画）
  - 数值：实时显示总心跳值余额（永久+今日赠送）
  - 格式：使用千分位分隔符
  - 点击行为：弹窗显示心跳值详情

**心跳值详情弹窗**:
```
💖 心跳值详情

总计：2,400 个心跳值

• 永久心跳值：2,350
• 今日赠送：50（24点清零）

每次发送消息消耗1点心跳值
优先消耗今日赠送心跳值

是否前往充值？
```

**交互规范**:
- 点击返回按钮跳转至 `homepage.html`
- 点击心跳值图标显示详细信息和充值入口
- 点击详情弹窗的"确定"跳转到 `recharge.html`

**验收标准**:
- [x] 头部信息显示正确
- [x] 返回功能正常
- [x] 在线状态实时更新
- [x] 心跳值实时同步显示
- [x] 心跳动画流畅
- [x] 详情弹窗信息准确

### 2. 消息显示功能 (F4.2)
**需求描述**: 展示对话历史和实时消息
**优先级**: P0 (必须实现)

**功能细节**:
- **消息气泡样式**:
  - 用户发送：右侧蓝紫色渐变气泡
  - AI回复：左侧白色气泡
  - 圆角设计，底部有小尖角
- **消息内容**:
  - 支持文本消息
  - 自动换行和断字
  - 最大宽度限制
- **时间戳**: 每条消息显示发送时间
- **头像显示**: AI消息显示人物头像

**技术要求**:
- 消息区域自动滚动到最新消息
- 支持长文本自适应高度
- 流畅的滚动体验

**验收标准**:
- [ ] 消息样式美观一致
- [ ] 时间显示准确
- [ ] 自动滚动功能正常
- [ ] 长消息显示完整

### 3. 智能回复功能 (F4.3)
**需求描述**: AI根据用户输入生成智能回复
**优先级**: P0 (必须实现)

**功能细节**:
- **回复延迟**: 模拟真人思考时间，1-3秒随机延迟
- **正在输入提示**: 显示"正在输入..."状态和动画
- **回复内容**: 
  - 根据用户消息生成相关回复
  - 保持人物性格一致性
  - 适当追问和关怀
- **上下文理解**: 结合聊天历史生成连贯回复

**AI要求**:
- 回复内容温暖自然
- 避免机械化模板回复
- 适当表达情感和关怀
- 引导对话深入

**验收标准**:
- [ ] 回复延迟合理自然
- [ ] 正在输入动画流畅
- [ ] 回复内容相关且有趣
- [ ] 保持角色性格一致

### 4. 心跳值消耗机制 (F4.4) 🔥核心商业化功能
**需求描述**: 发送消息时消耗心跳值，心跳值不足时引导充值
**优先级**: P0 (必须实现)

**功能细节**:

#### 4.1 消耗规则
- **消耗时机**: 用户点击发送按钮时
- **消耗数量**: 每条消息消耗1点心跳值
- **消耗顺序**: 
  1. 优先消耗每日赠送心跳值（dailyHeartBalance）
  2. 每日赠送用完后，消耗永久心跳值（heartBalance）
  3. 两者都不足时，阻止发送并提示充值

#### 4.2 心跳值检查逻辑
```javascript
发送消息前检查：
1. 获取dailyHeartBalance（每日赠送）
2. 获取heartBalance（永久心跳值）
3. 计算总计：totalBalance = dailyBalance + permanentBalance

if (totalBalance < 1) {
    // 心跳值不足
    弹窗提示："心跳值不足，无法发送消息。是否前往充值？"
    用户确认 → 跳转到recharge.html
    用户取消 → 停留在聊天页面
} else {
    // 心跳值充足，执行消耗逻辑
    if (dailyBalance >= 1) {
        dailyBalance -= 1  // 优先消耗每日赠送
    } else {
        permanentBalance -= 1  // 消耗永久心跳值
    }
    // 更新localStorage
    // 更新右上角显示
    // 发送消息
}
```

#### 4.3 心跳值不足提示
**弹窗内容**:
```
心跳值不足，无法发送消息。

是否前往充值？
```

**用户选择**:
- **确定**: 跳转到recharge.html充值页面
- **取消**: 关闭弹窗，停留在聊天页面

#### 4.4 心跳值显示更新
- **实时更新**: 每次发送消息后立即更新右上角显示
- **更新范围**: 
  - 右上角心跳值数字
  - localStorage中的数据
  - 其他页面（profile、recharge）自动同步

#### 4.5 与充值系统联动
**数据流转**:
```
chat.html (消耗) 
    ↓ localStorage
profile.html (显示余额)
    ↓ 点击充值
recharge.html (充值增加)
    ↓ localStorage
chat.html (余额更新)
```

**验收标准**:
- [x] 发送消息前检查心跳值
- [x] 优先消耗每日赠送心跳值
- [x] 心跳值不足时正确提示
- [x] 提示弹窗可跳转充值页面
- [x] 右上角余额实时更新
- [x] 与其他页面数据完全同步

---

### 5. 消息输入功能 (F4.5)
**需求描述**: 用户纯文字消息输入和发送（已移除表情功能）
**优先级**: P0 (必须实现)

**功能细节**:
- **输入框**:
  - 仅支持纯文字输入
  - 多行文本支持
  - 自动高度调整 (最大5行)
  - 占位符："输入消息..."
  - 背景：淡紫色半透明
  - 圆角容器设计

- **发送按钮**:
  - 圆形粉色渐变设计
  - 有内容时激活，无内容时禁用
  - 点击前先检查心跳值余额
  - 心跳值充足才能发送
  - 点击和键盘发送支持

**交互规范**:
- Enter键发送消息 (Shift+Enter换行)
- 发送后自动清空输入框
- 发送按钮状态跟随输入内容

**验收标准**:
- [x] 输入框自适应高度
- [x] 仅支持文字输入（无表情）
- [x] 发送前检查心跳值
- [x] 发送功能稳定
- [x] 键盘操作支持

### 6. 正在输入提示 (F4.6)
**需求描述**: 显示AI正在输入的状态
**优先级**: P1 (重要功能)

**功能细节**:
- **显示时机**: AI准备回复时显示
- **动画效果**: 三个点的跳动动画
- **状态同步**: 与头部在线状态联动
- **自动隐藏**: AI回复发送后自动消失

**验收标准**:
- [ ] 动画效果流畅
- [ ] 显示隐藏时机准确
- [ ] 与状态栏同步更新

---

## 🎨 设计风格要求

### 整体风格定位
- **设计主题**: 由设计师决定
- **色彩倾向**: 由设计师决定
- **视觉感受**: 由设计师决定

### 交互反馈要求
**点击效果**:
由设计师决定

**滚动效果**:
由设计师决定

---

## 📱 兼容性要求

### 设备适配
**主要适配**:
- iPhone 16 ～ X

**响应式要求**:
- 支持不同屏幕尺寸的自适应
- 移动端体验优化
- 安全区域适配

---

## ⚡ 性能要求

### 加载性能
- **首屏加载时间**: < 2秒
- **消息发送响应**: < 200ms
- **AI回复生成**: < 5秒

### 流畅度要求
- **滚动帧率**: 保持60fps
- **动画性能**: 无掉帧，流畅过渡
- **内存占用**: < 50MB

### 消息处理
- 支持1000+条消息历史
- 虚拟滚动优化长列表
- 图片消息懒加载

---

## 🔒 安全性要求

### 数据安全
- 聊天记录本地加密存储
- 消息传输HTTPS加密
- 敏感信息过滤

### 隐私保护
- 用户聊天记录隐私保护
- 支持聊天记录删除
- AI训练数据匿名化

---

## 🧪 测试用例

### 功能测试
1. **基础显示测试**
   - [ ] 页面正常加载，所有元素显示正确
   - [ ] 聊天历史正确显示
   - [ ] 头部信息准确

2. **消息发送测试**
   - [ ] 文本消息正常发送
   - [ ] 消息气泡样式正确
   - [ ] 时间戳显示准确

3. **AI回复测试**
   - [ ] AI能正常回复用户消息
   - [ ] 回复延迟合理
   - [ ] 正在输入提示正常

4. **输入功能测试**
   - [ ] 输入框自适应高度
   - [ ] 表情插入功能正常
   - [ ] 键盘快捷键支持

### 兼容性测试
- [ ] iPhone 16 原生Safari测试
- [ ] 不同分辨率设备适配测试
- [ ] 横竖屏切换测试
- [ ] 微信内置浏览器测试

### 性能测试
- [ ] 长对话滚动性能
- [ ] 大量消息加载测试
- [ ] 内存占用监控
- [ ] AI回复响应时间

### 心跳值消耗测试 🔥重要
- [x] 发送消息前检查心跳值
- [x] 优先消耗每日赠送心跳值
- [x] 每日赠送用完后消耗永久心跳值
- [x] 心跳值不足时阻止发送
- [x] 提示弹窗正确显示
- [x] 点击充值跳转到recharge.html
- [x] 右上角心跳值实时更新
- [x] 跨页面数据同步准确

---

## 📋 开发检查清单

### 前端开发
- [ ] HTML结构语义化完整
- [ ] CSS样式符合设计规范
- [ ] JavaScript交互功能实现
- [ ] 响应式布局适配
- [ ] 性能优化处理

### AI集成开发
- [ ] AI回复接口集成
- [ ] 上下文管理实现
- [ ] 人物性格保持
- [ ] 回复质量优化

### 测试验收
- [ ] 功能测试用例全部通过
- [ ] 兼容性测试覆盖主流设备
- [ ] 性能指标达到要求
- [ ] 用户体验走查完成

### 上线准备
- [ ] 代码安全审查
- [ ] 产品体验验收
- [ ] AI模型部署
- [ ] 监控埋点配置

---

## 💾 数据存储方案

### localStorage数据结构
```javascript
{
  // 心跳值数据（与充值系统联动）
  heartBalance: 2350,                    // 永久心跳值（充值获得）
  dailyHeartBalance: 50,                 // 每日赠送心跳值（24点清零）
  lastSignInDate: "Wed Oct 16 2025",    // 上次签到日期
  
  // 聊天相关数据
  chatHistory: {...},                    // 聊天记录
  currentCharacter: "alice_001",         // 当前聊天人物ID
  
  // 用户数据
  characterList: [...],                  // 已创建人物列表
  characterCount: 5,                     // 已创建人物数量
  createQuota: 10                        // 剩余创建额度
}
```

### 数据读取逻辑
**页面加载时**:
1. 读取heartBalance（永久心跳值）
2. 读取dailyHeartBalance（每日赠送）
3. 检查lastSignInDate，如果日期变化则清零dailyHeartBalance
4. 计算总计并显示在右上角

**发送消息时**:
1. 检查总心跳值是否≥1
2. 如果不足，显示充值提示
3. 如果充足，优先消耗dailyHeartBalance
4. 更新localStorage数据
5. 更新页面显示

### 数据同步机制
**跨页面同步**:
- 所有页面通过localStorage共享数据
- 任一页面更新后，其他页面下次加载时自动同步
- 实时性：离开页面时保存，进入页面时读取

**关键页面联动**:
```
chat.html (消耗心跳值)
    ↓ localStorage更新
profile.html (显示余额)
    ↓ 点击充值
recharge.html (增加心跳值)
    ↓ localStorage更新
chat.html (余额更新)
```

---

## 📝 变更记录

### v2.0 (2025-10-16) 
**重大更新：商业化功能集成**

**新增功能**:
- ✅ 右上角添加心跳值实时显示（❤️图标+数字）
- ✅ 发送消息消耗心跳值机制（每条1点）
- ✅ 心跳值不足时提示并引导充值
- ✅ 与recharge.html充值系统完全联动
- ✅ 优先消耗每日赠送心跳值逻辑
- ✅ 点击心跳图标显示详细信息

**移除功能**:
- ❌ 表情按钮（😊）- 简化输入，仅支持文字
- ❌ 更多操作按钮（⋯）- 聚焦核心聊天功能

**优化改进**:
- 心跳值动画效果（heartbeat动画）
- 数据实时同步机制
- 用户体验流程优化

### v1.0 (2025-08-24)
- 初始版本
- 基础聊天功能
- AI智能回复
- 消息输入输出

---

**文档维护**: 云养产品团队  
**最后更新**: 2025年10月16日  
**审核状态**: v2.0已实现